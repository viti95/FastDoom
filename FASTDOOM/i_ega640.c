#include <string.h>
#include <dos.h>
#include <conio.h>
#include <stdlib.h>
#include <stdio.h>
#include <stdarg.h>

#include "doomtype.h"
#include "i_ibm.h"
#include "v_video.h"
#include "tables.h"
#include "math.h"
#include "i_system.h"

#define CRTC_INDEX 0x3D4

#if defined(MODE_EGA640)

const byte colors[48] = {
    0x00, 0x00, 0x00,  // 0
    0x00, 0x00, 0x2A,  // 1
    0x00, 0x2A, 0x00,  // 2
    0x00, 0x2A, 0x2A,  // 3
    0x2A, 0x00, 0x00,  // 4
    0x2A, 0x00, 0x2A,  // 5
    0x2A, 0x15, 0x00,  // 6
    0x2A, 0x2A, 0x2A,  // 7
    0x15, 0x15, 0x15,  // 8
    0x15, 0x15, 0x3F,  // 9
    0x15, 0x3F, 0x15,  // 10
    0x15, 0x3F, 0x3F,  // 11
    0x3F, 0x15, 0x15,  // 12
    0x3F, 0x15, 0x3F,  // 13
    0x3F, 0x3F, 0x15,  // 14
    0x3F, 0x3F, 0x3F}; // 15

byte lutcolors[14 * 256] = {0,64,0,21,255,64,0,0,0,64,64,0,0,20,20,20,245,245,245,117,117,240,240,240,240,240,112,112,112,112,112,112,48,48,48,48,48,48,48,48,16,16,16,16,16,16,16,16,255,127,253,245,245,245,245,245,245,244,244,244,244,116,116,116,116,116,120,120,120,60,60,60,60,104,104,24,20,20,20,20,255,127,127,127,127,127,127,63,63,63,63,63,63,63,85,85,85,85,85,85,85,21,21,21,21,21,21,64,64,64,64,64,204,204,204,76,76,76,76,76,12,68,68,4,4,4,4,0,125,125,125,61,61,61,61,61,53,104,104,104,104,104,104,80,61,61,84,104,104,104,20,20,85,84,84,30,104,24,24,64,252,252,124,124,116,60,60,20,255,127,245,245,117,240,240,112,112,112,48,48,48,48,48,48,48,48,48,16,16,16,16,16,255,215,215,215,195,195,195,67,67,3,3,3,3,3,1,1,255,255,253,245,244,244,244,116,116,116,120,120,60,60,60,60,255,255,253,253,252,252,252,252,60,52,52,52,20,20,20,20,1,1,1,1,0,0,0,0,244,252,243,115,115,51,17,53,0,16,16,80,255,16,16,16,0,20,20,20,0,80,20,20,245,245,117,240,240,240,240,240,240,112,112,112,112,112,112,48,48,48,48,48,48,48,48,48,48,48,16,16,16,16,16,16,127,245,245,245,245,245,245,245,244,244,244,244,240,240,120,120,120,120,120,120,120,60,60,52,52,52,52,52,20,20,20,20,127,245,245,245,245,245,245,125,125,125,117,117,117,117,61,61,53,53,53,53,53,104,104,104,80,80,80,80,20,20,20,16,204,204,92,92,92,92,108,28,28,28,28,24,24,20,20,16,117,117,61,116,61,53,53,53,53,104,104,104,104,80,80,80,116,120,60,60,60,80,80,20,61,104,104,104,104,104,24,20,252,244,124,116,116,60,52,52,255,245,245,245,240,240,240,112,112,112,48,48,48,48,48,48,48,48,48,48,16,16,16,16,247,215,211,211,195,195,67,67,67,3,3,3,3,1,1,1,255,245,245,245,244,244,116,116,120,120,120,120,120,60,60,52,255,253,253,126,252,252,252,124,52,52,52,52,80,20,20,16,1,1,1,64,0,0,0,0,244,244,243,115,51,51,49,120,16,16,16,80,245,16,16,16,16,20,20,16,16,48,48,16,245,117,240,240,240,240,240,240,112,112,112,112,112,112,112,48,48,48,48,48,48,48,48,48,48,48,48,48,48,16,16,16,245,245,245,245,245,245,244,244,244,244,240,240,240,120,120,120,120,112,112,112,112,52,52,52,52,52,52,52,52,20,20,16,245,245,245,245,117,117,117,117,117,117,117,117,121,53,53,53,53,53,53,53,54,80,80,80,80,80,80,80,80,80,16,16,92,92,92,92,108,108,108,84,84,84,24,24,20,20,20,16,240,240,120,120,120,120,120,120,112,112,52,52,52,52,52,52,120,120,120,52,52,52,52,52,120,60,60,104,52,80,52,80,244,244,124,116,120,60,52,52,245,245,245,117,240,240,112,112,112,112,112,48,48,48,48,48,48,48,48,48,48,48,16,16,245,119,119,211,83,83,83,67,19,19,19,19,65,17,17,17,245,245,245,244,244,244,116,120,120,120,120,120,120,52,52,52,245,245,245,244,244,244,124,124,52,52,52,52,52,52,16,16,17,17,64,64,16,16,16,16,116,244,241,115,51,49,49,112,16,16,16,48,245,16,16,16,16,52,20,16,16,48,48,48,117,240,240,240,240,240,240,112,112,112,112,112,112,112,112,112,48,48,48,48,48,48,48,48,48,48,48,48,48,48,48,48,245,245,245,117,117,244,244,240,240,240,240,240,240,120,120,120,112,112,112,112,112,112,52,52,52,52,52,52,52,48,48,16,245,245,117,117,240,240,240,240,240,240,240,240,240,120,120,112,112,112,112,112,112,112,52,52,48,48,48,48,48,48,48,48,124,124,124,124,124,116,60,60,60,60,60,52,20,20,16,16,240,240,120,112,112,112,112,112,112,112,112,52,52,48,48,48,112,112,112,52,52,52,52,48,112,112,52,52,52,52,52,52,244,244,116,120,120,52,52,52,245,245,117,240,240,240,112,112,112,112,112,48,48,48,48,48,48,48,48,48,48,48,48,48,245,241,241,115,115,83,83,19,19,19,19,17,17,17,17,17,245,245,244,244,240,240,120,120,120,120,120,112,112,112,52,52,245,245,244,244,244,244,124,124,52,52,52,52,48,48,48,16,17,17,16,16,16,16,16,16,240,244,241,115,113,49,49,112,16,48,48,48,245,48,48,16,16,48,48,48,16,48,48,48,240,240,240,240,240,240,112,112,112,112,112,112,112,112,112,112,48,48,48,48,48,48,48,48,48,48,48,48,48,48,48,48,117,117,240,240,240,240,240,240,240,240,240,240,120,112,112,112,112,112,112,112,112,112,112,52,52,52,52,48,48,48,48,48,117,240,240,240,240,240,240,240,240,240,112,112,112,112,112,112,112,112,112,112,112,48,48,48,48,48,48,48,48,48,48,48,124,116,116,116,60,60,60,60,60,52,52,52,52,52,48,16,240,112,112,112,112,112,112,112,112,112,112,48,48,48,48,48,112,112,112,112,52,48,48,48,112,112,112,52,52,48,48,48,244,116,120,120,112,52,52,52,245,117,240,240,240,240,112,112,112,112,112,112,48,48,48,48,48,48,48,48,48,48,48,48,117,241,113,113,113,51,51,51,19,81,17,17,17,17,17,80,245,117,240,240,240,240,120,120,112,112,112,112,112,112,112,52,245,244,244,244,244,116,116,116,52,52,52,48,48,48,48,48,80,80,16,16,16,16,16,16,120,116,241,113,113,49,49,112,48,48,48,48,240,48,48,48,48,48,48,48,48,48,48,48,240,240,240,240,240,112,112,112,112,112,112,112,112,112,112,112,112,48,48,48,48,48,48,48,48,48,48,48,48,48,48,48,240,240,240,240,240,240,240,240,240,240,240,112,112,112,112,112,112,112,112,112,112,112,112,112,112,48,48,48,48,48,48,48,240,240,240,240,240,240,240,240,112,112,112,112,112,112,112,112,112,112,112,112,112,48,48,48,48,48,48,48,48,48,48,48,116,120,120,120,120,60,52,52,52,52,52,52,48,48,48,48,112,112,112,112,112,112,112,112,112,112,112,112,48,48,48,48,112,112,112,112,48,48,48,48,112,112,112,48,48,48,48,48,240,120,120,112,112,112,52,48,240,240,240,240,240,112,112,112,112,112,112,112,48,48,48,48,48,48,48,48,48,48,48,48,240,240,240,113,113,113,49,49,49,49,49,49,49,49,80,80,240,240,240,240,240,120,120,112,112,112,112,112,112,112,112,112,240,240,240,240,240,116,116,116,112,112,48,48,48,48,48,48,80,48,48,48,48,48,48,48,120,120,240,113,113,49,49,112,48,48,48,48,240,48,48,48,48,48,48,48,48,48,48,48,240,240,240,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,48,48,48,48,48,48,48,48,48,48,48,48,48,240,240,240,240,240,240,240,240,240,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,48,48,48,48,48,48,48,240,240,240,240,240,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,48,48,48,48,48,48,48,48,48,48,120,120,112,112,112,112,112,52,52,52,52,48,48,48,48,48,112,112,112,112,112,112,112,112,112,112,112,112,112,48,48,48,112,112,112,112,112,48,48,48,112,112,112,112,48,48,48,48,120,120,112,112,112,112,112,48,240,240,240,240,112,112,112,112,112,112,112,112,112,112,48,48,48,48,48,48,48,48,48,48,240,240,112,112,112,112,49,49,49,49,49,49,49,49,48,48,240,240,240,240,112,112,112,112,112,112,112,112,112,112,112,112,240,240,240,240,120,120,120,120,112,112,112,48,48,48,48,48,48,48,48,48,48,48,48,48,112,120,240,113,112,112,112,112,48,48,48,112,240,48,48,48,48,48,48,48,48,48,48,48,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,48,48,48,48,48,48,48,48,48,48,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,48,48,48,48,48,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,48,48,48,48,48,48,48,112,112,112,112,112,112,112,112,112,112,112,48,48,48,48,48,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,48,112,112,112,112,112,112,48,48,112,112,112,112,112,112,48,48,112,112,112,112,112,112,112,48,240,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,48,48,48,48,48,48,48,112,112,112,112,112,112,112,112,49,49,112,112,112,48,48,48,240,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,240,240,112,112,112,112,112,112,112,112,112,112,48,48,48,48,48,48,48,48,48,48,48,48,112,112,112,112,112,112,112,112,48,112,48,112,112,112,48,48,48,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,48,48,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,48,48,48,48,48,112,112,112,112,112,112,112,112,0,20,20,21,255,64,64,64,64,24,24,24,20,104,104,20,245,245,245,244,244,240,240,240,240,120,120,120,112,112,112,112,112,52,52,52,52,48,52,48,48,48,16,16,16,16,16,16,253,253,253,245,245,245,245,245,244,244,244,244,244,116,116,116,116,116,116,116,116,60,60,60,60,60,104,104,24,24,24,20,127,127,127,127,127,127,127,63,63,63,63,63,63,63,109,109,85,85,85,85,85,30,21,21,21,21,21,21,21,24,64,64,204,204,204,204,92,76,76,76,28,28,28,28,24,24,24,64,125,125,125,212,61,61,61,61,61,61,84,104,104,104,104,104,61,116,61,84,104,104,104,24,212,84,84,84,84,84,24,24,252,252,124,124,116,60,60,52,255,127,245,245,117,240,240,112,112,112,112,112,48,48,48,48,48,48,48,48,16,16,16,16,127,215,215,87,195,195,67,67,67,67,3,3,3,3,1,1,255,253,253,245,244,244,244,116,116,116,116,120,120,60,60,60,255,253,253,253,252,252,252,252,60,60,52,52,104,24,20,20,1,1,1,1,64,64,64,0,244,252,243,115,115,51,49,53,20,24,24,84,253,24,24,20,20,104,24,24,24,104,104,104,245,245,244,244,244,244,240,240,240,120,120,120,120,120,120,120,112,112,52,52,52,52,52,52,52,52,52,52,52,52,20,20,253,253,253,245,245,245,244,244,244,244,244,244,244,244,116,116,116,116,116,116,116,116,116,60,60,60,60,60,60,104,24,24,253,253,253,253,126,126,126,126,125,125,125,125,125,125,212,212,212,212,61,61,61,61,84,84,84,84,104,104,104,104,104,24,220,220,92,92,92,92,92,92,108,108,28,28,28,24,24,24,244,244,244,124,124,116,116,116,61,61,61,84,84,84,104,104,124,116,116,116,84,84,104,104,212,212,84,84,84,84,84,84,252,252,124,124,124,116,60,60,253,245,245,244,244,240,240,112,112,112,112,112,112,112,52,52,52,52,52,52,52,52,52,20,127,127,215,87,195,195,67,67,67,67,3,3,3,65,65,65,253,253,245,126,244,244,244,116,116,116,116,116,116,120,60,60,253,253,253,252,252,252,252,252,60,60,60,60,104,104,24,24,65,22,64,64,64,64,20,20,244,252,119,115,115,113,49,116,24,104,24,84,253,104,104,24,24,84,84,28,24,60,60,60,244,244,244,244,244,244,244,116,116,116,116,116,116,120,120,120,120,120,120,120,60,60,60,60,60,60,60,60,60,60,60,60,253,253,126,126,126,244,244,244,244,244,244,244,244,244,124,124,124,124,124,116,116,116,116,116,116,116,60,60,60,60,84,60,253,253,253,126,126,126,126,126,126,126,125,125,125,125,212,212,212,212,212,212,212,61,61,61,84,84,84,84,84,84,84,104,220,220,92,92,92,92,92,92,108,108,108,108,84,28,28,24,244,244,244,124,124,124,124,124,124,116,116,116,116,116,84,84,124,124,124,116,116,60,60,60,212,212,212,108,84,84,84,84,252,252,124,124,124,116,60,60,253,245,245,244,244,240,240,120,112,112,112,112,112,112,112,52,52,52,52,52,52,60,60,60,253,127,63,63,87,87,195,67,67,67,67,65,65,65,22,21,253,253,126,244,244,244,244,124,116,116,116,116,116,116,116,116,253,253,252,252,252,252,252,252,116,60,60,60,60,60,60,60,21,21,21,104,24,24,24,24,244,252,245,241,113,113,54,116,84,60,60,116,253,84,84,84,84,84,84,84,84,116,116,60,244,244,244,244,244,244,244,244,116,116,116,116,116,116,116,116,116,116,116,120,120,120,120,60,60,60,60,60,60,60,60,60,126,126,126,244,244,244,244,244,244,244,244,244,244,124,124,124,124,124,124,124,124,124,124,124,124,116,116,116,116,116,60,60,252,252,126,126,126,126,126,126,126,126,126,244,244,124,124,124,124,124,124,124,124,124,124,124,124,116,116,84,84,84,84,84,220,220,220,92,92,92,92,92,92,108,108,108,108,108,84,84,244,244,124,124,124,124,124,124,124,124,124,124,124,116,116,116,124,124,124,124,124,116,116,116,124,124,124,124,124,124,124,108,252,252,124,124,124,124,116,116,253,126,244,244,244,244,116,120,120,120,120,120,120,120,120,120,120,60,60,60,60,60,60,60,126,126,125,63,63,87,87,23,23,23,23,105,105,105,21,104,253,126,244,244,244,244,244,124,124,124,124,116,116,116,116,116,253,252,252,252,252,252,252,252,116,116,116,116,116,116,60,60,104,104,104,104,104,104,84,84,244,252,245,241,113,240,120,124,0,4,4,68,255,4,4,4,4,4,4,4,4,24,24,24,245,125,125,244,244,244,116,116,116,116,120,120,120,120,60,60,60,52,52,52,52,52,20,20,20,20,20,20,20,20,20,20,253,253,253,253,126,252,252,244,244,244,244,124,124,124,124,124,124,124,124,116,116,84,84,84,84,84,28,28,24,24,24,4,221,221,221,221,221,221,221,63,93,93,93,109,109,109,109,109,29,29,29,30,30,30,30,30,68,68,68,68,68,4,4,4,204,204,204,76,76,76,76,76,12,12,12,12,4,4,4,4,212,212,212,212,212,212,108,108,84,84,84,84,84,28,28,24,212,108,108,84,28,28,24,24,29,29,30,68,68,68,68,68,252,252,252,124,124,60,24,24,255,253,245,244,240,240,120,112,112,52,52,52,52,52,52,52,52,20,20,20,20,20,20,20,223,215,199,199,195,195,67,67,67,3,3,3,65,65,1,1,255,253,253,252,244,244,124,124,116,116,116,60,60,60,60,60,255,253,253,126,252,252,252,252,60,60,60,20,24,24,24,24,1,1,64,64,64,0,0,0,124,252,243,115,115,51,81,61};
byte *ptrlutcolors;

void I_ProcessPalette(byte *palette)
{
}

void I_SetPalette(int numpalette)
{
    ptrlutcolors = lutcolors + numpalette * 256;
}

byte vrambuffer1[16000 * 4];
byte vrambuffer2[16000 * 4];
byte buffer[16000 * 4];

void I_FinishUpdate(void)
{
    unsigned short i;
    
    byte *backbufferptr;
    byte *vrambufferptr;
    byte *bufferptr = buffer;

    if (destscreen == 0xA0000)
        vrambufferptr = vrambuffer1;
    else
        vrambufferptr = vrambuffer2;

    for (i = 0, backbufferptr = backbuffer; i < SCREENWIDTH * SCREENHEIGHT / 4; i++, backbufferptr += 4)
    {
        unsigned char color0 = ptrlutcolors[*(backbufferptr)];
        unsigned char color1 = ptrlutcolors[*(backbufferptr + 1)];
        unsigned char color2 = ptrlutcolors[*(backbufferptr + 2)];
        unsigned char color3 = ptrlutcolors[*(backbufferptr + 3)];
        
        buffer[i] = (color0 & 0xC0) | ((color1 & 0xC0) >> 2) | ((color2 & 0xC0) >> 4) | ((color3 & 0xC0) >> 6);
        buffer[i+16000] = ((color0 & 0x30) << 2) | (color1 & 0x30) | ((color2 & 0x30) >> 2) | ((color3 & 0x30) >> 4);
        buffer[i+32000] = ((color0 & 0x0C) << 4) | ((color1 & 0x0C) << 2) | ((color2 & 0x0C)) | ((color3 & 0x0C) >> 2);
        buffer[i+48000] = ((color0 & 0x03) << 6) | ((color1 & 0x03) << 4) | ((color2 & 0x03) << 2) | ((color3 & 0x03));
    }

    // Red
    outp(0x3C5, 1 << (3 & 0x03));
    for (i = 0; i < 16000; i++)
    {
        unsigned char data = bufferptr[i];

        if (data != vrambufferptr[i])
        {
            vrambufferptr[i] = data;
            destscreen[i] = data;
        }
    }

    // Green
    outp(0x3C5, 1 << (2 & 0x03));
    bufferptr += 16000;
    vrambufferptr += 16000;
    for (i = 0; i < 16000; i++)
    {
        unsigned char data = bufferptr[i];

        if (data != vrambufferptr[i])
        {
            vrambufferptr[i] = data;
            destscreen[i] = data;
        }
    }

    // Blue
    outp(0x3C5, 1 << (1 & 0x03));
    bufferptr += 16000;
    vrambufferptr += 16000;
    for (i = 0; i < 16000; i++)
    {
        unsigned char data = bufferptr[i];

        if (data != vrambufferptr[i])
        {
            vrambufferptr[i] = data;
            destscreen[i] = data;
        }
    }

    // Intensity
    outp(0x3C5, 1 << (0 & 0x03));
    bufferptr += 16000;
    vrambufferptr += 16000;
    for (i = 0; i < 16000; i++)
    {
        unsigned char data = bufferptr[i];

        if (data != vrambufferptr[i])
        {
            vrambufferptr[i] = data;
            destscreen[i] = data;
        }
    }

    // Change video page
    outpw(CRTC_INDEX, ((int)destscreen & 0xff00) + 0xc);

    // Next plane
    if (destscreen == 0xA4000)
        destscreen = 0xA0000;
    else
        destscreen += 0x4000;
}

void EGA_640_InitGraphics(void)
{
    union REGS regs;

    regs.w.ax = 0x0E;
    int386(0x10, (union REGS *)&regs, &regs);
    outp(0x3C4, 0x2);
    pcscreen = destscreen = (byte *)0xA4000;

    SetDWords(vrambuffer1, 0, 4000 * 4);
    SetDWords(vrambuffer2, 0, 4000 * 4);
    SetDWords(buffer,0, 4000 * 4);
}
#endif
