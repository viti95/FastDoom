#include <string.h>
#include <dos.h>
#include <conio.h>
#include <stdlib.h>
#include <stdio.h>
#include <stdarg.h>

#include "doomtype.h"
#include "doomstat.h"
#include "i_ibm.h"
#include "v_video.h"
#include "tables.h"
#include "math.h"
#include "i_system.h" 
#include "d_main.h"

#if defined(MODE_CGA512)

const unsigned char oldCGA55LUT[768] = {
    0x00, 0x00, 0x00, 0x03, 0x0e, 0x22, 0x00, 0x17, 0x00, 0x00, 0x1c, 0x15, 0x00, 0x00, 0x00, 0x04, 0x06, 0x1b, 0x01, 0x0c, 0x00, 0x01, 0x1d, 0x1d, 0x01, 0x0b, 0x12, 0x04, 0x19, 0x34, 0x00, 0x22, 0x11, 0x01, 0x28, 0x27, 0x01, 0x0b, 0x12, 0x05, 0x11, 0x2d, 0x02, 0x17, 0x0e, 0x02, 0x29, 0x2e, 0x0f, 0x02, 0x10, 0x13, 0x11, 0x36, 0x0b, 0x16, 0x12, 0x10, 0x1f, 0x25, 0x0f, 0x01, 0x0f, 0x13, 0x08, 0x2b, 0x0e, 0x0b, 0x0f, 0x11, 0x20, 0x2a, 0x10, 0x0d, 0x22, 0x14, 0x1c, 0x3f, 0x0c, 0x22, 0x24, 0x11, 0x2a, 0x37, 0x10, 0x0d, 0x21, 0x14, 0x13, 0x3d, 0x0f, 0x17, 0x20, 0x12, 0x2b, 0x3c, 0x0b, 0x09, 0x00, 0x0d, 0x17, 0x15, 0x0b, 0x23, 0x00, 0x0e, 0x29, 0x06, 0x0c, 0x0b, 0x00, 0x11, 0x11, 0x10, 0x0e, 0x17, 0x00, 0x0f, 0x2a, 0x0c, 0x0c, 0x14, 0x08, 0x0e, 0x22, 0x27, 0x0c, 0x2e, 0x03, 0x0f, 0x34, 0x17, 0x0d, 0x16, 0x06, 0x12, 0x1c, 0x21, 0x0f, 0x23, 0x00, 0x10, 0x35, 0x1e, 0x00, 0x00, 0x00, 0x02, 0x0e, 0x1d, 0x00, 0x17, 0x00, 0x03, 0x1f, 0x10, 0x00, 0x00, 0x00, 0x04, 0x06, 0x19, 0x00, 0x0a, 0x00, 0x03, 0x1f, 0x14, 0x01, 0x0b, 0x11, 0x03, 0x19, 0x2f, 0x00, 0x22, 0x11, 0x04, 0x2b, 0x21, 0x01, 0x0b, 0x12, 0x05, 0x11, 0x2b, 0x00, 0x15, 0x11, 0x04, 0x2b, 0x26, 0x26, 0x09, 0x14, 0x27, 0x16, 0x2e, 0x22, 0x1f, 0x11, 0x25, 0x25, 0x24, 0x27, 0x0a, 0x1b, 0x2a, 0x0f, 0x2e, 0x27, 0x16, 0x0b, 0x26, 0x26, 0x28, 0x27, 0x15, 0x26, 0x28, 0x22, 0x3f, 0x23, 0x2a, 0x23, 0x26, 0x30, 0x36, 0x28, 0x16, 0x2d, 0x2a, 0x1a, 0x3f, 0x28, 0x21, 0x1d, 0x27, 0x31, 0x39, 0x1a, 0x02, 0x17, 0x1e, 0x11, 0x3d, 0x16, 0x17, 0x19, 0x1a, 0x1e, 0x2e, 0x1c, 0x03, 0x20, 0x20, 0x09, 0x3a, 0x19, 0x0c, 0x15, 0x1c, 0x20, 0x2e, 0x1b, 0x0d, 0x29, 0x1f, 0x1c, 0x3f, 0x17, 0x22, 0x2a, 0x1b, 0x29, 0x3f, 0x1d, 0x0f, 0x32, 0x21, 0x15, 0x3f, 0x1b, 0x17, 0x27, 0x1d, 0x2b, 0x3f, 0x15, 0x09, 0x00, 0x19, 0x18, 0x1d, 0x12, 0x1f, 0x00, 0x16, 0x26, 0x10, 0x14, 0x08, 0x00, 0x18, 0x0e, 0x14, 0x19, 0x18, 0x00, 0x19, 0x2a, 0x13, 0x16, 0x15, 0x0d, 0x1a, 0x24, 0x2f, 0x13, 0x2b, 0x0e, 0x17, 0x31, 0x22, 0x15, 0x14, 0x0f, 0x19, 0x19, 0x26, 0x1a, 0x24, 0x06, 0x1a, 0x36, 0x25, 0x28, 0x0c, 0x0c, 0x2b, 0x1a, 0x34, 0x24, 0x21, 0x0f, 0x29, 0x28, 0x2b, 0x27, 0x0b, 0x0e, 0x2c, 0x11, 0x33, 0x28, 0x17, 0x0a, 0x2d, 0x2d, 0x2d, 0x29, 0x18, 0x1e, 0x2c, 0x25, 0x3f, 0x25, 0x2c, 0x20, 0x2a, 0x33, 0x3d, 0x28, 0x16, 0x20, 0x2d, 0x1c, 0x3f, 0x29, 0x22, 0x1c, 0x2e, 0x39, 0x3f, 0x11, 0x06, 0x00, 0x14, 0x15, 0x22, 0x0f, 0x1e, 0x00, 0x11, 0x23, 0x15, 0x11, 0x06, 0x00, 0x15, 0x0d, 0x1c, 0x12, 0x13, 0x00, 0x12, 0x24, 0x1d, 0x12, 0x12, 0x12, 0x15, 0x20, 0x33, 0x10, 0x29, 0x10, 0x12, 0x2e, 0x27, 0x11, 0x12, 0x12, 0x16, 0x18, 0x2d, 0x13, 0x1e, 0x0e, 0x13, 0x2f, 0x2e, 0x20, 0x08, 0x10, 0x24, 0x17, 0x36, 0x1c, 0x1d, 0x12, 0x21, 0x26, 0x25, 0x1f, 0x08, 0x0f, 0x24, 0x0e, 0x2b, 0x1f, 0x12, 0x0f, 0x22, 0x27, 0x2a, 0x21, 0x13, 0x22, 0x24, 0x22, 0x3f, 0x1c, 0x28, 0x23, 0x22, 0x31, 0x37, 0x20, 0x13, 0x21, 0x25, 0x19, 0x3d, 0x20, 0x1d, 0x20, 0x22, 0x31, 0x3c, 0x1c, 0x10, 0x00, 0x1e, 0x1d, 0x15, 0x1c, 0x29, 0x00, 0x1f, 0x2f, 0x06, 0x1d, 0x11, 0x00, 0x22, 0x18, 0x10, 0x1f, 0x1e, 0x00, 0x20, 0x30, 0x0c, 0x1c, 0x1a, 0x07, 0x1f, 0x29, 0x27, 0x1d, 0x34, 0x03, 0x20, 0x3b, 0x17, 0x1e, 0x1c, 0x06, 0x23, 0x23, 0x21, 0x20, 0x29, 0x00, 0x21, 0x3b, 0x1e, 0x11, 0x07, 0x00, 0x13, 0x14, 0x1e, 0x0f, 0x1d, 0x00, 0x14, 0x26, 0x10, 0x11, 0x06, 0x00, 0x15, 0x0c, 0x1a, 0x10, 0x10, 0x00, 0x14, 0x26, 0x14, 0x12, 0x12, 0x11, 0x14, 0x1f, 0x2f, 0x10, 0x29, 0x11, 0x15, 0x31, 0x22, 0x11, 0x12, 0x12, 0x16, 0x17, 0x2b, 0x11, 0x1b, 0x11, 0x15, 0x31, 0x25, 0x36, 0x10, 0x14, 0x38, 0x1d, 0x2f, 0x33, 0x26, 0x11, 0x36, 0x2b, 0x25, 0x38, 0x11, 0x1c, 0x3b, 0x16, 0x2e, 0x38, 0x1d, 0x0c, 0x37, 0x2d, 0x28, 0x37, 0x1b, 0x26, 0x39, 0x28, 0x3f, 0x34, 0x31, 0x23, 0x36, 0x36, 0x36, 0x39, 0x1c, 0x2d, 0x3b, 0x21, 0x3f, 0x39, 0x28, 0x1d, 0x37, 0x38, 0x39, 0x2b, 0x09, 0x17, 0x2f, 0x18, 0x3d, 0x28, 0x1d, 0x19, 0x2b, 0x25, 0x2e, 0x2d, 0x0a, 0x20, 0x31, 0x10, 0x3a, 0x2a, 0x13, 0x16, 0x2d, 0x27, 0x2e, 0x2c, 0x14, 0x29, 0x30, 0x23, 0x3f, 0x28, 0x29, 0x2a, 0x2c, 0x2f, 0x3f, 0x2e, 0x15, 0x31, 0x32, 0x1b, 0x3f, 0x2b, 0x1e, 0x27, 0x2e, 0x32, 0x3f, 0x26, 0x10, 0x00, 0x2a, 0x1f, 0x1d, 0x23, 0x26, 0x00, 0x27, 0x2d, 0x10, 0x25, 0x0f, 0x00, 0x29, 0x15, 0x14, 0x2a, 0x1f, 0x00, 0x2a, 0x31, 0x13, 0x27, 0x1b, 0x0d, 0x2a, 0x2a, 0x2f, 0x24, 0x31, 0x0d, 0x28, 0x38, 0x22, 0x26, 0x1a, 0x0f, 0x2a, 0x20, 0x26, 0x2a, 0x2a, 0x06, 0x2b, 0x3c, 0x25, 0x39, 0x13, 0x0d, 0x3c, 0x21, 0x34, 0x35, 0x28, 0x0f, 0x3a, 0x2f, 0x2b, 0x38, 0x12, 0x0f, 0x3d, 0x18, 0x33, 0x39, 0x1d, 0x0b, 0x3e, 0x34, 0x2d, 0x3a, 0x1e, 0x1e, 0x3d, 0x2c, 0x3f, 0x36, 0x33, 0x20, 0x3a, 0x3a, 0x3d, 0x39, 0x1d, 0x20, 0x3e, 0x23, 0x3f, 0x3a, 0x29, 0x1c, 0x3f, 0x3f, 0x3f};
const unsigned char oldCGA13LUT[768] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0d, 0x1c, 0x00, 0x02, 0x14, 0x00, 0x0d, 0x06, 0x00, 0x00, 0x00, 0x00, 0x14, 0x19, 0x00, 0x10, 0x1e, 0x00, 0x04, 0x0e, 0x00, 0x04, 0x0e, 0x00, 0x12, 0x2a, 0x00, 0x06, 0x23, 0x00, 0x12, 0x15, 0x00, 0x04, 0x0e, 0x00, 0x18, 0x27, 0x00, 0x14, 0x2c, 0x00, 0x15, 0x0c, 0x35, 0x13, 0x11, 0x36, 0x22, 0x29, 0x25, 0x17, 0x20, 0x2f, 0x1f, 0x11, 0x2f, 0x1a, 0x0b, 0x37, 0x26, 0x24, 0x25, 0x2c, 0x29, 0x2a, 0x19, 0x1a, 0x2f, 0x17, 0x1f, 0x31, 0x26, 0x37, 0x20, 0x1b, 0x2e, 0x2a, 0x24, 0x20, 0x2a, 0x1e, 0x19, 0x32, 0x2a, 0x32, 0x20, 0x30, 0x37, 0x25, 0x00, 0x03, 0x01, 0x00, 0x00, 0x00, 0x0b, 0x23, 0x00, 0x01, 0x16, 0x00, 0x0b, 0x06, 0x00, 0x00, 0x00, 0x00, 0x14, 0x18, 0x00, 0x10, 0x1d, 0x00, 0x03, 0x11, 0x00, 0x04, 0x0e, 0x00, 0x0f, 0x31, 0x00, 0x05, 0x24, 0x00, 0x0f, 0x15, 0x00, 0x04, 0x0e, 0x00, 0x18, 0x27, 0x00, 0x15, 0x2b, 0x00, 0x02, 0x07, 0x14, 0x00, 0x0c, 0x15, 0x0e, 0x29, 0x06, 0x03, 0x1f, 0x10, 0x0c, 0x0d, 0x0e, 0x02, 0x07, 0x14, 0x12, 0x1f, 0x03, 0x15, 0x24, 0x07, 0x06, 0x16, 0x0f, 0x04, 0x1a, 0x10, 0x12, 0x37, 0x00, 0x07, 0x2e, 0x0b, 0x10, 0x1b, 0x08, 0x06, 0x15, 0x0f, 0x16, 0x2e, 0x00, 0x19, 0x32, 0x02, 0x14, 0x03, 0x1c, 0x15, 0x03, 0x1d, 0x22, 0x22, 0x0e, 0x17, 0x19, 0x18, 0x27, 0x0a, 0x1b, 0x17, 0x04, 0x1e, 0x2d, 0x1c, 0x11, 0x25, 0x20, 0x0e, 0x18, 0x11, 0x17, 0x19, 0x12, 0x17, 0x26, 0x30, 0x08, 0x1b, 0x28, 0x13, 0x2b, 0x18, 0x16, 0x1b, 0x12, 0x19, 0x31, 0x2a, 0x0c, 0x2a, 0x2e, 0x09, 0x1a, 0x09, 0x37, 0x18, 0x09, 0x36, 0x28, 0x28, 0x28, 0x1b, 0x1f, 0x31, 0x26, 0x10, 0x32, 0x20, 0x09, 0x3a, 0x28, 0x22, 0x25, 0x30, 0x25, 0x2a, 0x1e, 0x17, 0x32, 0x1c, 0x18, 0x30, 0x2c, 0x37, 0x23, 0x1f, 0x2d, 0x2c, 0x2a, 0x1e, 0x2d, 0x25, 0x18, 0x35, 0x2c, 0x30, 0x20, 0x34, 0x33, 0x25, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x0d, 0x1d, 0x00, 0x02, 0x15, 0x00, 0x0b, 0x06, 0x00, 0x00, 0x00, 0x00, 0x19, 0x18, 0x00, 0x15, 0x1d, 0x00, 0x04, 0x0e, 0x00, 0x03, 0x10, 0x00, 0x11, 0x2b, 0x00, 0x06, 0x23, 0x00, 0x0f, 0x15, 0x00, 0x04, 0x0e, 0x00, 0x1d, 0x27, 0x00, 0x19, 0x2c, 0x00, 0x19, 0x0c, 0x37, 0x15, 0x11, 0x37, 0x25, 0x2d, 0x29, 0x16, 0x24, 0x31, 0x21, 0x12, 0x30, 0x15, 0x0d, 0x36, 0x2a, 0x25, 0x28, 0x2d, 0x2d, 0x2d, 0x1d, 0x1a, 0x32, 0x19, 0x1f, 0x32, 0x29, 0x3b, 0x23, 0x1b, 0x32, 0x2c, 0x26, 0x20, 0x2b, 0x18, 0x1b, 0x31, 0x2e, 0x33, 0x22, 0x31, 0x3c, 0x28, 0x0e, 0x03, 0x17, 0x0e, 0x04, 0x17, 0x1b, 0x20, 0x07, 0x10, 0x18, 0x11, 0x1b, 0x0a, 0x13, 0x0e, 0x03, 0x17, 0x22, 0x1c, 0x09, 0x1e, 0x21, 0x09, 0x12, 0x12, 0x12, 0x12, 0x12, 0x11, 0x1f, 0x2e, 0x01, 0x14, 0x26, 0x0c, 0x1f, 0x18, 0x0d, 0x11, 0x11, 0x12, 0x25, 0x2a, 0x03, 0x22, 0x2f, 0x03, 0x22, 0x0f, 0x3f, 0x21, 0x14, 0x3f, 0x30, 0x2d, 0x3c, 0x25, 0x24, 0x3f, 0x2d, 0x15, 0x3f, 0x28, 0x0f, 0x3f, 0x34, 0x28, 0x3c, 0x3a, 0x2c, 0x3f, 0x26, 0x1d, 0x3f, 0x24, 0x22, 0x3f, 0x34, 0x3b, 0x37, 0x29, 0x32, 0x3f, 0x31, 0x23, 0x3f, 0x2c, 0x1d, 0x3f, 0x37, 0x36, 0x37, 0x3e, 0x3a, 0x3c, 0x0d, 0x06, 0x18, 0x0e, 0x03, 0x16, 0x19, 0x26, 0x09, 0x0f, 0x1a, 0x12, 0x19, 0x0a, 0x12, 0x0e, 0x04, 0x17, 0x22, 0x1c, 0x08, 0x1e, 0x21, 0x08, 0x10, 0x14, 0x12, 0x11, 0x12, 0x11, 0x1d, 0x34, 0x03, 0x13, 0x28, 0x0c, 0x1d, 0x18, 0x0c, 0x11, 0x11, 0x11, 0x25, 0x2a, 0x03, 0x22, 0x2f, 0x03, 0x10, 0x0b, 0x2b, 0x0e, 0x10, 0x2d, 0x1c, 0x2c, 0x1d, 0x11, 0x23, 0x27, 0x19, 0x11, 0x25, 0x10, 0x0a, 0x2b, 0x20, 0x23, 0x1b, 0x23, 0x28, 0x1e, 0x14, 0x19, 0x26, 0x12, 0x1e, 0x27, 0x20, 0x3a, 0x17, 0x15, 0x31, 0x22, 0x1d, 0x1f, 0x1f, 0x14, 0x18, 0x26, 0x24, 0x31, 0x15, 0x27, 0x36, 0x19, 0x22, 0x07, 0x34, 0x23, 0x07, 0x34, 0x30, 0x26, 0x25, 0x25, 0x1d, 0x2f, 0x35, 0x0e, 0x32, 0x25, 0x07, 0x35, 0x3b, 0x20, 0x28, 0x33, 0x23, 0x26, 0x25, 0x15, 0x2e, 0x26, 0x15, 0x2e, 0x34, 0x34, 0x1f, 0x29, 0x2b, 0x2a, 0x39, 0x1c, 0x2d, 0x29, 0x15, 0x30, 0x3f, 0x2e, 0x23, 0x37, 0x31, 0x20, 0x28, 0x0d, 0x3f, 0x26, 0x0d, 0x3f, 0x35, 0x2c, 0x3f, 0x28, 0x23, 0x3f, 0x34, 0x14, 0x3f, 0x2e, 0x0d, 0x3f, 0x36, 0x25, 0x3c, 0x3e, 0x28, 0x3f, 0x2c, 0x1b, 0x3f, 0x2a, 0x1b, 0x3f, 0x39, 0x3a, 0x39, 0x2c, 0x31, 0x3f, 0x38, 0x22, 0x3f, 0x32, 0x1b, 0x3f, 0x39, 0x33, 0x37, 0x3f, 0x36, 0x3c, 0x0e, 0x03, 0x17, 0x0d, 0x05, 0x18, 0x1b, 0x21, 0x07, 0x10, 0x19, 0x12, 0x19, 0x0a, 0x12, 0x0e, 0x03, 0x17, 0x27, 0x1c, 0x0b, 0x23, 0x21, 0x0c, 0x12, 0x11, 0x12, 0x11, 0x13, 0x12, 0x1f, 0x2f, 0x02, 0x14, 0x27, 0x0c, 0x1d, 0x18, 0x0d, 0x11, 0x11, 0x12, 0x2a, 0x2a, 0x06, 0x27, 0x2f, 0x06, 0x27, 0x0f, 0x3f, 0x23, 0x14, 0x3f, 0x33, 0x30, 0x3f, 0x24, 0x28, 0x3f, 0x2f, 0x15, 0x3f, 0x23, 0x11, 0x3f, 0x38, 0x28, 0x3f, 0x3b, 0x31, 0x3f, 0x2b, 0x1d, 0x3f, 0x27, 0x22, 0x3f, 0x36, 0x3f, 0x3a, 0x28, 0x36, 0x3f, 0x33, 0x24, 0x3f, 0x26, 0x1f, 0x3f, 0x3c, 0x36, 0x3a, 0x3f, 0x3f, 0x3f};
const unsigned char newCGA55LUT[768] = {
    0x00, 0x00, 0x00, 0x00, 0x09, 0x1d, 0x00, 0x18, 0x0f, 0x00, 0x1d, 0x25, 0x00, 0x05, 0x09, 0x00, 0x0a, 0x23, 0x00, 0x16, 0x18, 0x00, 0x22, 0x34, 0x00, 0x0f, 0x1e, 0x00, 0x19, 0x3b, 0x00, 0x28, 0x2d, 0x00, 0x2d, 0x3f, 0x00, 0x15, 0x28, 0x00, 0x19, 0x3f, 0x00, 0x26, 0x36, 0x00, 0x32, 0x3f, 0x0f, 0x00, 0x08, 0x0b, 0x09, 0x27, 0x02, 0x16, 0x19, 0x01, 0x1d, 0x2c, 0x0c, 0x04, 0x11, 0x0b, 0x09, 0x2a, 0x04, 0x15, 0x23, 0x00, 0x22, 0x3a, 0x07, 0x0f, 0x26, 0x03, 0x19, 0x3f, 0x00, 0x26, 0x38, 0x00, 0x2d, 0x3f, 0x04, 0x14, 0x2f, 0x03, 0x19, 0x3f, 0x00, 0x24, 0x3f, 0x00, 0x32, 0x3f, 0x19, 0x07, 0x00, 0x15, 0x11, 0x09, 0x0e, 0x21, 0x00, 0x0c, 0x27, 0x0e, 0x17, 0x0d, 0x00, 0x16, 0x13, 0x0f, 0x10, 0x1f, 0x03, 0x09, 0x2b, 0x1b, 0x11, 0x17, 0x0c, 0x0c, 0x21, 0x27, 0x06, 0x31, 0x18, 0x04, 0x36, 0x2c, 0x0f, 0x1d, 0x14, 0x0e, 0x22, 0x2d, 0x08, 0x2f, 0x21, 0x01, 0x3b, 0x3a, 0x1a, 0x04, 0x00, 0x15, 0x0e, 0x11, 0x0d, 0x1c, 0x05, 0x0c, 0x23, 0x16, 0x17, 0x09, 0x00, 0x16, 0x0e, 0x19, 0x0f, 0x19, 0x12, 0x09, 0x28, 0x23, 0x12, 0x14, 0x15, 0x0d, 0x1e, 0x2f, 0x05, 0x2c, 0x24, 0x04, 0x33, 0x35, 0x0f, 0x19, 0x1f, 0x0e, 0x1e, 0x37, 0x07, 0x29, 0x31, 0x01, 0x37, 0x3f, 0x1f, 0x01, 0x05, 0x1a, 0x0b, 0x1d, 0x13, 0x19, 0x13, 0x10, 0x1e, 0x27, 0x1d, 0x06, 0x14, 0x1b, 0x0b, 0x28, 0x16, 0x18, 0x1a, 0x0e, 0x24, 0x32, 0x17, 0x11, 0x24, 0x12, 0x1a, 0x3c, 0x0b, 0x29, 0x31, 0x08, 0x2e, 0x3f, 0x15, 0x16, 0x32, 0x13, 0x1b, 0x3f, 0x0e, 0x28, 0x38, 0x06, 0x33, 0x3f, 0x1f, 0x00, 0x08, 0x1b, 0x09, 0x28, 0x12, 0x16, 0x1a, 0x11, 0x1c, 0x2f, 0x1d, 0x04, 0x18, 0x1c, 0x09, 0x31, 0x15, 0x15, 0x23, 0x0f, 0x22, 0x37, 0x17, 0x0f, 0x27, 0x13, 0x19, 0x3f, 0x0a, 0x26, 0x39, 0x09, 0x2c, 0x3f, 0x15, 0x14, 0x37, 0x14, 0x19, 0x3f, 0x0d, 0x24, 0x3f, 0x07, 0x32, 0x3f, 0x29, 0x08, 0x00, 0x25, 0x12, 0x0a, 0x1c, 0x1f, 0x00, 0x1a, 0x25, 0x12, 0x26, 0x0c, 0x00, 0x25, 0x11, 0x0f, 0x20, 0x1f, 0x02, 0x19, 0x2b, 0x1c, 0x21, 0x17, 0x0c, 0x1d, 0x22, 0x29, 0x14, 0x2f, 0x1c, 0x12, 0x35, 0x30, 0x1e, 0x1c, 0x17, 0x1c, 0x21, 0x2d, 0x18, 0x2f, 0x21, 0x11, 0x3b, 0x3b, 0x3a, 0x08, 0x00, 0x35, 0x10, 0x16, 0x2d, 0x1e, 0x08, 0x2b, 0x24, 0x21, 0x37, 0x0c, 0x01, 0x36, 0x10, 0x21, 0x30, 0x1d, 0x0f, 0x2a, 0x2b, 0x2b, 0x33, 0x17, 0x14, 0x2d, 0x20, 0x35, 0x25, 0x2e, 0x26, 0x24, 0x33, 0x3f, 0x2f, 0x1b, 0x1f, 0x2e, 0x20, 0x3f, 0x28, 0x2c, 0x2e, 0x23, 0x3a, 0x3f, 0x1c, 0x05, 0x00, 0x17, 0x0f, 0x13, 0x10, 0x1d, 0x05, 0x0e, 0x22, 0x1b, 0x19, 0x0a, 0x00, 0x18, 0x0f, 0x19, 0x13, 0x1b, 0x0f, 0x0b, 0x27, 0x2a, 0x14, 0x14, 0x14, 0x0f, 0x1e, 0x31, 0x08, 0x2c, 0x23, 0x05, 0x31, 0x39, 0x11, 0x19, 0x1e, 0x10, 0x1e, 0x37, 0x0a, 0x2b, 0x2c, 0x03, 0x36, 0x3f, 0x2c, 0x04, 0x00, 0x27, 0x0e, 0x1e, 0x1f, 0x1b, 0x10, 0x1e, 0x22, 0x22, 0x29, 0x09, 0x07, 0x28, 0x0e, 0x21, 0x21, 0x1a, 0x19, 0x1b, 0x27, 0x30, 0x24, 0x14, 0x1c, 0x1f, 0x1d, 0x3c, 0x16, 0x2a, 0x2e, 0x15, 0x31, 0x3f, 0x21, 0x18, 0x25, 0x1f, 0x1d, 0x3f, 0x19, 0x29, 0x37, 0x13, 0x36, 0x3f, 0x36, 0x0c, 0x00, 0x31, 0x16, 0x00, 0x2a, 0x26, 0x00, 0x28, 0x2b, 0x04, 0x34, 0x12, 0x00, 0x33, 0x17, 0x05, 0x2d, 0x24, 0x00, 0x26, 0x30, 0x12, 0x2d, 0x1c, 0x02, 0x29, 0x25, 0x1d, 0x22, 0x35, 0x0d, 0x20, 0x3b, 0x22, 0x2b, 0x22, 0x0a, 0x2a, 0x27, 0x23, 0x25, 0x33, 0x17, 0x1e, 0x3f, 0x30, 0x36, 0x09, 0x00, 0x31, 0x13, 0x07, 0x2a, 0x21, 0x00, 0x29, 0x28, 0x0d, 0x34, 0x0e, 0x00, 0x32, 0x13, 0x0f, 0x2b, 0x1e, 0x09, 0x26, 0x2d, 0x19, 0x2e, 0x18, 0x0b, 0x29, 0x22, 0x25, 0x21, 0x30, 0x1a, 0x20, 0x37, 0x2b, 0x2b, 0x1d, 0x15, 0x2a, 0x22, 0x2d, 0x23, 0x2e, 0x26, 0x1e, 0x3c, 0x37, 0x3c, 0x06, 0x00, 0x37, 0x10, 0x13, 0x2f, 0x1e, 0x09, 0x2d, 0x23, 0x1d, 0x3a, 0x0b, 0x0a, 0x38, 0x10, 0x1d, 0x32, 0x1d, 0x10, 0x2a, 0x29, 0x28, 0x34, 0x15, 0x19, 0x2e, 0x1f, 0x31, 0x27, 0x2d, 0x27, 0x25, 0x33, 0x3b, 0x31, 0x1a, 0x28, 0x2f, 0x1f, 0x3c, 0x2a, 0x2c, 0x2e, 0x22, 0x38, 0x3f, 0x3c, 0x04, 0x00, 0x38, 0x0e, 0x1e, 0x2f, 0x1b, 0x11, 0x2d, 0x21, 0x25, 0x3a, 0x09, 0x0e, 0x38, 0x0e, 0x27, 0x31, 0x1a, 0x1a, 0x2b, 0x27, 0x2e, 0x34, 0x14, 0x1d, 0x2f, 0x1d, 0x3c, 0x27, 0x2b, 0x2e, 0x25, 0x30, 0x3f, 0x31, 0x19, 0x2c, 0x30, 0x1e, 0x3f, 0x29, 0x29, 0x37, 0x23, 0x36, 0x3f, 0x3f, 0x0d, 0x00, 0x3f, 0x17, 0x00, 0x39, 0x24, 0x00, 0x37, 0x2a, 0x08, 0x3f, 0x11, 0x00, 0x3f, 0x16, 0x05, 0x3d, 0x24, 0x00, 0x36, 0x31, 0x13, 0x3d, 0x1c, 0x02, 0x39, 0x26, 0x1e, 0x30, 0x33, 0x12, 0x2e, 0x39, 0x26, 0x3a, 0x20, 0x0d, 0x39, 0x26, 0x23, 0x34, 0x34, 0x16, 0x2d, 0x3f, 0x30, 0x3f, 0x0c, 0x00, 0x3f, 0x15, 0x0c, 0x3f, 0x23, 0x00, 0x3f, 0x29, 0x18, 0x3f, 0x11, 0x00, 0x3f, 0x15, 0x17, 0x3f, 0x22, 0x06, 0x3f, 0x30, 0x21, 0x3f, 0x1c, 0x0a, 0x3f, 0x25, 0x2a, 0x3f, 0x32, 0x1c, 0x3f, 0x38, 0x36, 0x3f, 0x20, 0x15, 0x3f, 0x24, 0x36, 0x3f, 0x31, 0x24, 0x3f, 0x3f, 0x3f};
const unsigned char newCGA13LUT[768] = {
    0x00, 0x00, 0x00, 0x00, 0x05, 0x00, 0x02, 0x1e, 0x00, 0x00, 0x20, 0x00, 0x07, 0x09, 0x00, 0x00, 0x0c, 0x00, 0x07, 0x23, 0x00, 0x03, 0x2b, 0x00, 0x00, 0x16, 0x00, 0x00, 0x1b, 0x00, 0x01, 0x35, 0x00, 0x00, 0x36, 0x00, 0x07, 0x1f, 0x00, 0x00, 0x22, 0x00, 0x06, 0x39, 0x00, 0x02, 0x3f, 0x00, 0x0e, 0x01, 0x2c, 0x0b, 0x09, 0x27, 0x10, 0x20, 0x08, 0x09, 0x21, 0x0f, 0x14, 0x0b, 0x1e, 0x11, 0x0c, 0x22, 0x13, 0x24, 0x02, 0x16, 0x2a, 0x00, 0x0c, 0x17, 0x16, 0x0a, 0x1f, 0x11, 0x0f, 0x37, 0x00, 0x09, 0x37, 0x00, 0x13, 0x21, 0x08, 0x10, 0x22, 0x0b, 0x12, 0x3b, 0x00, 0x15, 0x3f, 0x00, 0x0d, 0x00, 0x1d, 0x0e, 0x03, 0x18, 0x0e, 0x21, 0x00, 0x0a, 0x1f, 0x00, 0x15, 0x08, 0x0f, 0x0e, 0x0b, 0x11, 0x16, 0x21, 0x00, 0x12, 0x29, 0x00, 0x0c, 0x17, 0x07, 0x0d, 0x1a, 0x01, 0x0d, 0x37, 0x00, 0x09, 0x36, 0x00, 0x14, 0x1f, 0x00, 0x0d, 0x21, 0x00, 0x15, 0x37, 0x00, 0x11, 0x3f, 0x00, 0x12, 0x01, 0x34, 0x10, 0x09, 0x2f, 0x12, 0x23, 0x10, 0x0c, 0x23, 0x16, 0x17, 0x0b, 0x26, 0x12, 0x0d, 0x28, 0x17, 0x24, 0x09, 0x17, 0x2b, 0x05, 0x11, 0x18, 0x1e, 0x0f, 0x1f, 0x19, 0x11, 0x39, 0x00, 0x0b, 0x3a, 0x00, 0x16, 0x21, 0x0f, 0x11, 0x23, 0x12, 0x16, 0x3a, 0x00, 0x17, 0x3f, 0x00, 0x12, 0x00, 0x1f, 0x12, 0x02, 0x1b, 0x15, 0x1e, 0x00, 0x0e, 0x1e, 0x02, 0x1d, 0x06, 0x14, 0x14, 0x09, 0x15, 0x1d, 0x1f, 0x00, 0x17, 0x27, 0x00, 0x11, 0x14, 0x0a, 0x12, 0x19, 0x05, 0x14, 0x34, 0x00, 0x0d, 0x35, 0x00, 0x1c, 0x1c, 0x00, 0x13, 0x1f, 0x00, 0x1c, 0x36, 0x00, 0x16, 0x3e, 0x00, 0x19, 0x00, 0x3b, 0x17, 0x04, 0x35, 0x1a, 0x1f, 0x17, 0x13, 0x1f, 0x1d, 0x1f, 0x08, 0x2d, 0x1c, 0x09, 0x31, 0x1c, 0x22, 0x10, 0x20, 0x27, 0x0d, 0x17, 0x15, 0x25, 0x16, 0x1a, 0x1f, 0x19, 0x35, 0x01, 0x12, 0x36, 0x07, 0x1e, 0x1e, 0x17, 0x1b, 0x20, 0x1b, 0x1b, 0x38, 0x00, 0x1f, 0x3d, 0x00, 0x15, 0x00, 0x2b, 0x15, 0x04, 0x26, 0x17, 0x1d, 0x06, 0x11, 0x1e, 0x0d, 0x1b, 0x07, 0x1d, 0x15, 0x0a, 0x1f, 0x20, 0x1f, 0x02, 0x1c, 0x28, 0x00, 0x15, 0x14, 0x15, 0x14, 0x1a, 0x10, 0x16, 0x33, 0x00, 0x10, 0x35, 0x00, 0x1b, 0x1e, 0x06, 0x14, 0x20, 0x09, 0x1f, 0x36, 0x00, 0x1b, 0x3e, 0x00, 0x26, 0x00, 0x3f, 0x22, 0x07, 0x3f, 0x26, 0x20, 0x34, 0x1e, 0x21, 0x3a, 0x2a, 0x09, 0x3f, 0x22, 0x0c, 0x3f, 0x2b, 0x22, 0x2e, 0x2a, 0x2b, 0x2b, 0x25, 0x15, 0x3f, 0x21, 0x1d, 0x3d, 0x25, 0x36, 0x1e, 0x1d, 0x38, 0x24, 0x29, 0x1f, 0x33, 0x21, 0x22, 0x35, 0x2a, 0x38, 0x18, 0x2a, 0x3f, 0x15, 0x15, 0x00, 0x2a, 0x15, 0x03, 0x25, 0x18, 0x1d, 0x06, 0x11, 0x1e, 0x0d, 0x1d, 0x07, 0x1d, 0x15, 0x0a, 0x1f, 0x1d, 0x21, 0x01, 0x19, 0x29, 0x00, 0x14, 0x14, 0x14, 0x14, 0x19, 0x0f, 0x17, 0x33, 0x00, 0x10, 0x34, 0x00, 0x1c, 0x1d, 0x06, 0x13, 0x20, 0x08, 0x1b, 0x37, 0x00, 0x17, 0x3f, 0x00, 0x23, 0x00, 0x3f, 0x20, 0x07, 0x3f, 0x25, 0x1f, 0x33, 0x1f, 0x1f, 0x39, 0x29, 0x09, 0x3f, 0x26, 0x0a, 0x3f, 0x29, 0x23, 0x2d, 0x2b, 0x29, 0x2a, 0x22, 0x15, 0x3f, 0x1f, 0x1d, 0x3c, 0x24, 0x35, 0x1c, 0x1e, 0x35, 0x23, 0x28, 0x1f, 0x32, 0x25, 0x20, 0x36, 0x27, 0x39, 0x16, 0x2a, 0x3f, 0x14, 0x23, 0x00, 0x3f, 0x24, 0x02, 0x3f, 0x23, 0x1f, 0x24, 0x1f, 0x1e, 0x2a, 0x2a, 0x06, 0x3a, 0x24, 0x09, 0x3c, 0x2b, 0x1f, 0x1e, 0x28, 0x27, 0x19, 0x21, 0x15, 0x31, 0x23, 0x18, 0x2c, 0x22, 0x35, 0x0d, 0x1e, 0x34, 0x13, 0x29, 0x1c, 0x23, 0x22, 0x1f, 0x25, 0x2a, 0x35, 0x07, 0x26, 0x3d, 0x02, 0x28, 0x00, 0x3f, 0x25, 0x07, 0x3f, 0x28, 0x21, 0x3b, 0x21, 0x21, 0x3f, 0x2d, 0x09, 0x3f, 0x27, 0x0b, 0x3f, 0x2c, 0x22, 0x34, 0x2d, 0x29, 0x30, 0x26, 0x15, 0x3f, 0x24, 0x1d, 0x3f, 0x27, 0x37, 0x24, 0x20, 0x37, 0x2b, 0x2c, 0x1f, 0x3a, 0x26, 0x21, 0x3c, 0x2b, 0x38, 0x1e, 0x2c, 0x3f, 0x1a, 0x28, 0x00, 0x3f, 0x28, 0x00, 0x3f, 0x2a, 0x1c, 0x27, 0x24, 0x1d, 0x2d, 0x33, 0x04, 0x3f, 0x29, 0x07, 0x3f, 0x32, 0x1e, 0x22, 0x2c, 0x26, 0x1c, 0x26, 0x12, 0x34, 0x27, 0x16, 0x2f, 0x29, 0x32, 0x10, 0x22, 0x32, 0x17, 0x31, 0x1a, 0x28, 0x28, 0x1d, 0x29, 0x31, 0x34, 0x0c, 0x2b, 0x3c, 0x05, 0x2e, 0x00, 0x3f, 0x2c, 0x02, 0x3f, 0x30, 0x1d, 0x3f, 0x29, 0x1d, 0x3f, 0x35, 0x06, 0x3f, 0x32, 0x08, 0x3f, 0x31, 0x20, 0x3b, 0x36, 0x25, 0x38, 0x2d, 0x13, 0x3f, 0x2b, 0x18, 0x3f, 0x2f, 0x33, 0x2c, 0x27, 0x33, 0x31, 0x33, 0x1c, 0x3f, 0x30, 0x1e, 0x3f, 0x30, 0x36, 0x24, 0x34, 0x3b, 0x22, 0x2b, 0x00, 0x3f, 0x2a, 0x02, 0x3f, 0x2d, 0x1b, 0x31, 0x26, 0x1c, 0x38, 0x31, 0x06, 0x3f, 0x2a, 0x08, 0x3f, 0x35, 0x1e, 0x2d, 0x32, 0x26, 0x28, 0x2a, 0x12, 0x3f, 0x29, 0x18, 0x3a, 0x2b, 0x31, 0x1b, 0x25, 0x32, 0x21, 0x30, 0x1c, 0x31, 0x29, 0x1e, 0x33, 0x34, 0x34, 0x16, 0x30, 0x3c, 0x12, 0x3c, 0x00, 0x3f, 0x37, 0x05, 0x3f, 0x3c, 0x1e, 0x3f, 0x33, 0x1f, 0x3f, 0x3f, 0x07, 0x3f, 0x38, 0x0a, 0x3f, 0x3f, 0x20, 0x3f, 0x3f, 0x29, 0x3f, 0x3b, 0x13, 0x3f, 0x36, 0x1b, 0x3f, 0x3a, 0x34, 0x3f, 0x32, 0x35, 0x3f, 0x3f, 0x1d, 0x3f, 0x36, 0x20, 0x3f, 0x3f, 0x36, 0x3f, 0x3f, 0x3f, 0x3f};

unsigned short lut256colors[14 * 256];
unsigned short *ptrlut256colors;
unsigned short vrambuffer[8000];

void I_ProcessPalette(byte *palette)
{
    int i, j;
    unsigned char *ptrLUT55;
    unsigned char *ptrLUT13;
    byte *ptr = gammatable[usegamma];

    if (CGAmodel == CGA_OLD)
    {
        ptrLUT55 = oldCGA55LUT;
        ptrLUT13 = oldCGA13LUT;
    }

    if (CGAmodel == CGA_NEW)
    {
        ptrLUT55 = newCGA55LUT;
        ptrLUT13 = newCGA13LUT;
    }

    for (i = 0; i < 14 * 256; i++)
    {
        int distance;

        int r1, g1, b1;

        int best_difference = MAXINT;

        r1 = (int)ptr[*palette++];
        g1 = (int)ptr[*palette++];
        b1 = (int)ptr[*palette++];

        for (j = 0; j < 256; j++)
        {
            int r2, g2, b2;
            int cR, cG, cB;
            int pos = j * 3;
            unsigned short value;

            r2 = (int)ptrLUT55[pos];
            cR = (r2 - r1) * (r2 - r1);

            g2 = (int)ptrLUT55[pos + 1];
            cG = (g2 - g1) * (g2 - g1);

            b2 = (int)ptrLUT55[pos + 2];
            cB = (b2 - b1) * (b2 - b1);

            distance = cR + cG + cB;

            if (distance == 0)
            {
                value = (j & 0x0F) << 12 | (j & 0xF0) << 4 | 0x55;
                lut256colors[i] = value;
                break;
            }

            distance = SQRT(distance);

            if (best_difference > distance)
            {
                best_difference = distance;
                value = (j & 0x0F) << 12 | (j & 0xF0) << 4 | 0x55;
                lut256colors[i] = value;
            }
        }

        if (distance != 0)
        {
            for (j = 0; j < 256; j++)
            {
                int r2, g2, b2;
                int cR, cG, cB;
                int pos = j * 3;
                unsigned short value;

                r2 = (int)ptrLUT13[pos];
                cR = (r2 - r1) * (r2 - r1);

                g2 = (int)ptrLUT13[pos + 1];
                cG = (g2 - g1) * (g2 - g1);

                b2 = (int)ptrLUT13[pos + 2];
                cB = (b2 - b1) * (b2 - b1);

                distance = cR + cG + cB;

                if (distance == 0)
                {
                    value = (j & 0x0F) << 12 | (j & 0xF0) << 4 | 0x13;
                    lut256colors[i] = value;
                    break;
                }

                distance = SQRT(distance);

                if (best_difference > distance)
                {
                    best_difference = distance;
                    value = (j & 0x0F) << 12 | (j & 0xF0) << 4 | 0x13;
                    lut256colors[i] = value;
                }
            }
        }
    }
}

void I_SetPalette(int numpalette)
{
    ptrlut256colors = lut256colors + numpalette * 256;
}

void I_FinishUpdate(void)
{
    unsigned short *vram = (unsigned short *)0xB8000;
    byte *ptrbackbuffer = backbuffer;
    unsigned short *ptrvrambuffer = vrambuffer;
    unsigned char line = 80;

    do
    {
        unsigned short tmp = ptrlut256colors[*ptrbackbuffer];

        if (*ptrvrambuffer != tmp)
        {
            *ptrvrambuffer = tmp;
            I_WaitCGA();
            *vram = tmp;
        }

        vram += 1;
        ptrvrambuffer += 1;
        ptrbackbuffer += 4;

        line--;
        if (line == 0)
        {
            line = 80;
            ptrbackbuffer += 320;
        }
    } while (vram < (unsigned short *)0xBBE80);
}

void CGA_512_InitGraphics(void)
{
    union REGS regs;
    unsigned char *vram = (unsigned char *)0xB8000;
    int i;

    // Set 80x25 color mode
    regs.h.ah = 0x00;
    regs.h.al = 0x03;
    int386(0x10, &regs, &regs);

    // Disable cursor
    regs.h.ah = 0x01;
    regs.h.ch = 0x3F;
    int386(0x10, &regs, &regs);

    // Disable blinking
    regs.h.ah = 0x10;
    regs.h.al = 0x03;
    regs.h.bl = 0x00;
    regs.h.bh = 0x00;
    int386(0x10, &regs, &regs);

    /* set mode control register for 80x25 text mode and disable video output */
    outp(0x3D8, 1);

    /*
        These settings put the 6845 into "graphics" mode without actually
        switching the CGA controller into graphics mode.  The register
        values are directly copied from CGA graphics mode register
        settings.  The 6845 does not directly display graphics, the
        6845 only generates addresses and sync signals, the CGA
        attribute controller either displays character ROM data or color
        pixel data, this is external to the 6845 and keeps the CGA card
        in text mode.
        ref: HELPPC
    */

    /* set vert total lines to 127 */
    outp(0x3D4, 0x04);
    outp(0x3D5, 0x7F);
    /* set vert displayed char rows to 100 */
    outp(0x3D4, 0x06);
    outp(0x3D5, 0x64);
    /* set vert sync position to 112 */
    outp(0x3D4, 0x07);
    outp(0x3D5, 0x70);
    /* set char scan line count to 1 */
    outp(0x3D4, 0x09);
    outp(0x3D5, 0x01);

    /* re-enable the video output in 80x25 text mode */
    outp(0x3D8, 9);

    /* init screen */
}

#endif
